<?xml version="1.0" encoding="UTF-8"?>

<!--
    Family Tree Builder MSI Installer
    WiX v6 format
-->

<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

    <Package 
        Name="Family Tree Builder" 
        Manufacturer="Family Tree Builder"
        Version="1.0.0.0" 
        UpgradeCode="8E7B5A3C-1234-5678-9ABC-DEF012345678"
        Scope="perMachine"
        Language="1033"
        Codepage="1252">

        <SummaryInformation Description="Family Tree Builder Installation Package"
                            Manufacturer="Family Tree Builder"/>

        <MajorUpgrade 
            DowngradeErrorMessage="A newer version of [ProductName] is already installed." 
            AllowSameVersionUpgrades="yes"/>

        <!-- Icon for Add/Remove Programs -->
        <Icon Id="AppIcon.ico" SourceFile="..\FamilyTreeApp\Assets\app.ico"/>
        <Property Id="ARPPRODUCTICON" Value="AppIcon.ico"/>
        <Property Id="ARPHELPLINK" Value="https://github.com/familytreebuilder"/>
        <Property Id="ARPURLINFOABOUT" Value="https://github.com/familytreebuilder"/>

        <!-- Media -->
        <MediaTemplate EmbedCab="yes" CompressionLevel="high"/>

        <!-- Standard Directory Structure -->
        <StandardDirectory Id="ProgramFiles64Folder">
            <Directory Id="INSTALLFOLDER" Name="Family Tree Builder"/>
        </StandardDirectory>

        <!-- Start Menu -->
        <StandardDirectory Id="ProgramMenuFolder">
            <Directory Id="ApplicationProgramsFolder" Name="Family Tree Builder"/>
        </StandardDirectory>

        <!-- Desktop -->
        <StandardDirectory Id="DesktopFolder"/>

        <!-- Main Application Files -->
        <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
            
            <!-- Main Executable with shortcuts -->
            <Component Id="MainExecutable" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">
                <File Id="FamilyTreeBuilderExe" 
                      Source="..\publish\FamilyTreeBuilder.exe" 
                      KeyPath="yes"/>

                <!-- Start Menu Shortcut -->
                <Shortcut Id="StartMenuShortcut" 
                          Directory="ApplicationProgramsFolder" 
                          Name="Family Tree Builder" 
                          WorkingDirectory="INSTALLFOLDER" 
                          Icon="AppIcon.ico"/>

                <!-- Desktop Shortcut -->
                <Shortcut Id="DesktopShortcut" 
                          Directory="DesktopFolder" 
                          Name="Family Tree Builder" 
                          WorkingDirectory="INSTALLFOLDER" 
                          Icon="AppIcon.ico"/>

                <!-- Remove folders on uninstall -->
                <RemoveFolder Id="RemoveApplicationProgramsFolder" Directory="ApplicationProgramsFolder" On="uninstall"/>
            </Component>

            <!-- File Association Component -->
            <Component Id="FileAssociation" Guid="C3D4E5F6-A7B8-9012-CDEF-345678901234">
                <RegistryValue Root="HKLM" Key="Software\FamilyTreeBuilder" Name="Installed" Type="integer" Value="1" KeyPath="yes"/>
                
                <!-- Register .tree file extension -->
                <ProgId Id="FamilyTreeBuilder.TreeFile" Description="Family Tree File" Icon="FamilyTreeBuilderExe">
                    <Extension Id="tree" ContentType="application/x-familytree">
                        <Verb Id="open" Command="Open" TargetFile="FamilyTreeBuilderExe" Argument='"%1"'/>
                    </Extension>
                </ProgId>
            </Component>

            <!-- Icon file -->
            <Component Id="IconFile" Guid="B2C3D4E5-F6A7-8901-BCDE-F23456789012">
                <File Id="AppIconFile" Source="..\FamilyTreeApp\Assets\app.ico" KeyPath="yes"/>
            </Component>

        </ComponentGroup>

        <!-- Runtime Files - All DLLs and dependencies from publish folder -->
        <ComponentGroup Id="RuntimeComponents" Directory="INSTALLFOLDER">
            <Files Include="..\publish\*.dll">
                <Exclude Files="..\publish\FamilyTreeBuilder.exe"/>
            </Files>
            <Files Include="..\publish\*.json"/>
        </ComponentGroup>

        <!-- Feature -->
        <Feature Id="ProductFeature" Title="Family Tree Builder" Level="1">
            <ComponentGroupRef Id="ProductComponents"/>
            <ComponentGroupRef Id="RuntimeComponents"/>
        </Feature>

        <!-- WiX UI with Exit Dialog customization for Launch App checkbox -->
        <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER"/>
        <WixVariable Id="WixUILicenseRtf" Value="License.rtf"/>
        
        <!-- Launch application after install -->
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch Family Tree Builder"/>
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1"/>
        <Property Id="WixShellExecTarget" Value="[#FamilyTreeBuilderExe]"/>
        <CustomAction Id="LaunchApplication" DllEntry="WixShellExec" Impersonate="yes" BinaryRef="Wix4UtilCA_X86"/>
        <InstallExecuteSequence>
            <Custom Action="LaunchApplication" After="InstallFinalize" Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed"/>
        </InstallExecuteSequence>

    </Package>

</Wix>
